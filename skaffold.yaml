apiVersion: skaffold/v2alpha2
kind: Config

build:
  artifacts:
    - image: shopozor/assets-fixtures
      context: .
      docker:
        dockerfile: ./backend/assets-service/Dockerfile
  local:
    push: false

# TODO: for dev purposes, we need all services served on NodePort
# TODO: use dev namespace
deploy:
  helm:
    releases:
      - name: minio
        chartPath: bitnami/minio
        remote: true
        namespace: default
        values:
        overrides:
          fullnameOverride: minio
          mode: standalone
          clusterDomain: cluster.local
          persistence:
            enabled: false
            size: 10Gi
          disableWebUI: false
    flags:
      upgrade:
        - --install
  kubectl:
    manifests:
      - backend/assets-service/k8s/setup/*
      - backend/assets-service/k8s/testing/*
    flags:
      apply:
        - --namespace=default

profiles:
  - name: staging
    deploy:
      helm:
        releases:
          - name: minio
            chartPath: bitnami/minio
            remote: true
            namespace: staging
            values:
            overrides:
              fullnameOverride: minio
              mode: distributed
              # clusterDomain: cluster.local
              persistence:
                enabled: true
                storageClass: jelastic-dynamic-volume
                size: 10Gi
              disableWebUI: false
        flags:
          upgrade:
            - --install
      kubectl:
        manifests:
          - backend/assets-service/k8s/setup/*
          - backend/assets-service/k8s/testing/*
        flags:
          apply:
            - --namespace=staging
  - name: production
    deploy:
      helm:
        releases:
          - name: minio
            chartPath: bitnami/minio
            remote: true
            namespace: production
            values:
            overrides:
              fullnameOverride: minio
              mode: distributed
              persistence:
                enabled: true
                storageClass: jelastic-dynamic-volume
                size: 10Gi
              disableWebUI: true
        flags:
          upgrade:
            - --install
      kubectl:
        manifests:
          - backend/assets-service/k8s/setup/*
        flags:
          apply:
            - --namespace=production